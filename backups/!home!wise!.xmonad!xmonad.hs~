import XMonad
import XMonad.Hooks.DynamicLog
import XMonad.Hooks.ManageDocks
import XMonad.Hooks.SetWMName
import XMonad.Util.Run(spawnPipe)
import XMonad.Util.EZConfig(additionalKeys)
import System.IO
import Graphics.X11.ExtraTypes.XF86

import XMonad.Layout.Spacing
import XMonad.Layout.NoBorders(smartBorders)
import XMonad.Layout.PerWorkspace
import XMonad.Layout.IM as IM
import XMonad.Layout.Grid
import XMonad.Layout.Reflect

myWorkspaces = ["1:main","2:work","3:web","4:skype","5:mail","6:music","7:media","8:torrent"]

wiseManageHook = composeAll
      [
        className =? "File Operation Progress" --> doFloat
      , resource =? "desktop_window" --> doIgnore
      , className =? "xfce4-notifyd" --> doIgnore
      , className =? "Chromium" --> doShift "3:web"
      , className =? "Firefox" --> doShift "3:web"
      , className =? "Opera" --> doShift "3:web"
      , className =? "Skype" --> doShift "4:skype"
      , className =? "Emacs" --> doShift "2:work"
      , className =? "Deluge" --> doShift "8:torrent"
      , className =? "Deadbeef" --> doShift "6:music"
      --, className =? "Shotwell" --> doShift "5:graphic"
      --, className =? "Gimp" --> doShift "5:graphic"
      , className =? "Vlc" --> doShift "7:media"
      ]

wiseLayout = onWorkspace "4:skype" imLayout $ onWorkspaces ["2:work", "3:web", "7:media"] nobordersLayout $ tiled ||| Mirror tiled ||| nobordersLayout
    where
      tiled = spacing 2 $ Tall nmaster delta ratio
      nmaster = 1
      ratio = 2/3
      delta = 5/100
      nobordersLayout = smartBorders $ Full
      gridLayout = spacing 2 $ Grid
      imLayout = IM.withIM (0.18) (Role "roster") $ reflectHoriz $ IM.withIM (0.22) isSkype (Mirror tiled ||| Full)
          where
            isSkype = (IM.Or (IM.Title "wisemaverick - Skype™ (Beta)")(IM.Title "Skype™ 2.1 (Beta) for Linux"))


myKeys = [ ((mod4Mask, xK_r), spawn "gmrun")
         , ((mod4Mask, xK_n), spawn "wicd-client -n")
         , ((mod4Mask, xK_e), spawn "emacs")
         , ((mod4Mask, xK_l), spawn "xscreensaver-command -lock")
         , ((mod4Mask, xK_w), spawn "chromium")
         , ((mod4Mask .|. shiftMask, xK_w), spawn "chromium --incognito")
         , ((mod4Mask, xK_a), spawn "urxvt -e mc")
         , ((0, 0x1008FF12), spawn "amixer set Master toggle") -- mute volume
         ]

main = do
    xmproc <- spawnPipe "/usr/bin/xmobar /home/wise/.xmobarrc"
    --spawn "xcompmgr -Cf"
    xmonad $ defaultConfig
        { startupHook = setWMName "LG3D" -- needed for Java Swing applications
        , terminal  = "urxvt"
        , workspaces = myWorkspaces
        , manageHook = manageDocks <+> wiseManageHook <+> manageHook defaultConfig
        , layoutHook = avoidStruts  $ wiseLayout
        , logHook = dynamicLogWithPP xmobarPP
                        { ppOutput = hPutStrLn xmproc
                        , ppTitle = xmobarColor "green" "" . shorten 50
                        }
        , modMask = mod4Mask   -- Rebind Mod to the Windows key
        , normalBorderColor = "#60A1AD"
        , focusedBorderColor = "#68e862"
        , borderWidth = 1
        }
        `additionalKeys` myKeys